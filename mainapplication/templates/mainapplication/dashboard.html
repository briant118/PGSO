{% extends 'base.html' %}
{% block title %}Dashboard – PGSO{% endblock %}
{% block content %}
<div class="dashboard">
  <h1 class="dashboard-header">Dashboard</h1>
  <p class="dashboard-subtitle">Welcome. Use the side menu to navigate through the application.</p>

  <!-- Stats Summary Chart -->
  <section class="dashboard-chart-section dashboard-chart-section-top">
    <h2 class="dashboard-chart-title"><i class="fas fa-chart-pie"></i> Resident Statistics Overview</h2>
    <p class="dashboard-chart-subtitle">Summary of all resident categories and counts</p>
    <div class="dashboard-chart-wrap dashboard-chart-wrap-large">
      <canvas id="statsChart" height="280"></canvas>
    </div>
  </section>

  <!-- Charts Grid -->
  <div class="dashboard-charts-grid">
    <!-- Alive vs Deceased by Year and Month -->
    <section class="dashboard-chart-section">
      <h2 class="dashboard-chart-title"><i class="fas fa-chart-bar"></i> Alive vs Deceased by Year and Month</h2>
      <p class="dashboard-chart-subtitle">Resident count by registration month (current status: Alive / Deceased)</p>
      <div class="dashboard-chart-totals">
        <span class="chart-total-badge chart-total-alive"><i class="fas fa-heart"></i> Total Alive: <strong>{{ stats.total_alive|default:0 }}</strong></span>
        <span class="chart-total-badge chart-total-dead"><i class="fas fa-cross"></i> Total Deceased: <strong>{{ stats.total_dead|default:0 }}</strong></span>
      </div>
      <div class="dashboard-chart-wrap">
        <canvas id="aliveDeadChart" height="220"></canvas>
      </div>
    </section>

    <!-- Birth Year Chart -->
    <section class="dashboard-chart-section">
      <h2 class="dashboard-chart-title"><i class="fas fa-birthday-cake"></i> Residents Born by Year</h2>
      <p class="dashboard-chart-subtitle">Track which birth year has the most residents</p>
      <div id="birthYearPeak" class="dashboard-chart-peak" style="display: none;"></div>
      <div class="dashboard-chart-wrap">
        <canvas id="birthYearChart" height="220"></canvas>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
  var chartData = {{ chart_data_json|safe }};
  if (!chartData || !chartData.labels || !chartData.labels.length) {
    document.getElementById('aliveDeadChart').parentElement.innerHTML = '<p class="dashboard-chart-empty">No resident data by month yet.</p>';
    return;
  }
  var ctx = document.getElementById('aliveDeadChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: chartData.labels,
      datasets: [
        {
          label: 'Alive',
          data: chartData.alive,
          backgroundColor: 'rgba(40, 167, 69, 0.8)',
          borderColor: 'rgb(40, 167, 69)',
          borderWidth: 1
        },
        {
          label: 'Deceased',
          data: chartData.dead,
          backgroundColor: 'rgba(220, 53, 69, 0.8)',
          borderColor: 'rgb(220, 53, 69)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top'
        },
        tooltip: {
          callbacks: {
            afterBody: function(tooltipItems) {
              var idx = tooltipItems[0].dataIndex;
              var a = chartData.alive[idx] || 0;
              var d = chartData.dead[idx] || 0;
              return 'Total: ' + (a + d);
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Year – Month' },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Count' },
          ticks: { stepSize: 1 }
        }
      }
    }
  });
})();

// Birth Year Chart
(function() {
  var birthYearData = {{ birth_year_data_json|safe }};
  if (!birthYearData || !birthYearData.labels || !birthYearData.labels.length) {
    document.getElementById('birthYearChart').parentElement.innerHTML = '<p class="dashboard-chart-empty">No birth year data available yet.</p>';
    return;
  }
  var ctx = document.getElementById('birthYearChart').getContext('2d');
  var maxCount = Math.max.apply(null, birthYearData.counts);
  var maxYearIdx = birthYearData.counts.indexOf(maxCount);
  var maxYear = birthYearData.labels[maxYearIdx];
  
  // Show peak year info
  var peakEl = document.getElementById('birthYearPeak');
  if (peakEl) {
    peakEl.innerHTML = '<i class="fas fa-star"></i> Peak Year: <strong>' + maxYear + '</strong> with <strong>' + maxCount + '</strong> residents';
    peakEl.style.display = 'block';
  }
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: birthYearData.labels,
      datasets: [{
        label: 'Residents Born',
        data: birthYearData.counts,
        backgroundColor: function(context) {
          var idx = context.dataIndex;
          if (birthYearData.labels[idx] === maxYear) {
            return 'rgba(255, 193, 7, 0.9)'; // Highlight max year in gold/yellow
          }
          return 'rgba(66, 153, 225, 0.6)';
        },
        borderColor: function(context) {
          var idx = context.dataIndex;
          if (birthYearData.labels[idx] === maxYear) {
            return 'rgb(255, 193, 7)';
          }
          return 'rgb(66, 153, 225)';
        },
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            afterLabel: function(context) {
              var year = birthYearData.labels[context.dataIndex];
              if (year === maxYear) {
                return 'Peak year';
              }
              return '';
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Birth Year' },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Number of Residents' },
          ticks: { stepSize: 1 }
        }
      }
    }
  });
})();

// Stats Summary Chart
(function() {
  var statsChartData = {{ stats_chart_data_json|safe }};
  if (!statsChartData || !statsChartData.labels || !statsChartData.labels.length) {
    var statsChartEl = document.getElementById('statsChart');
    if (statsChartEl) {
      statsChartEl.parentElement.innerHTML = '<p class="dashboard-chart-empty">No statistics data available yet.</p>';
    }
    return;
  }
  var ctx = document.getElementById('statsChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: statsChartData.labels,
      datasets: [{
        label: 'Count',
        data: statsChartData.counts,
        backgroundColor: statsChartData.colors,
        borderColor: statsChartData.borderColors,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.parsed.y + ' resident' + (context.parsed.y !== 1 ? 's' : '');
            }
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Category' },
          grid: { display: false },
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Count' },
          ticks: { stepSize: 1 }
        }
      }
    }
  });
})();
</script>
{% endblock %}
