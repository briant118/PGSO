{% extends 'base.html' %}
{% block title %}Dashboard â€“ PGSO{% endblock %}
{% block content %}
<div class="dashboard dashboard-rms">
  <header class="dashboard-rms-header">
    <h1 class="dashboard-rms-title">Dashboard</h1>
    <p class="dashboard-rms-subtitle">Resident Management System</p>
  </header>

  <!-- Top row: 4 stat cards -->
  <div class="dashboard-rms-cards">
    <div class="dashboard-rms-card">
      <div class="dashboard-rms-card-icon-wrap dashboard-rms-icon-blue">
        <i class="fas fa-users"></i>
      </div>
      <div class="dashboard-rms-card-body">
        <span class="dashboard-rms-card-value">{{ stats.total_residents_record|default:0 }}</span>
        <span class="dashboard-rms-card-label">Total Residents</span>
      </div>
    </div>
    <div class="dashboard-rms-card">
      <div class="dashboard-rms-card-icon-wrap dashboard-rms-icon-green">
        <i class="fas fa-mars"></i>
      </div>
      <div class="dashboard-rms-card-body">
        <span class="dashboard-rms-card-value">{{ stats.total_male|default:0 }}</span>
        <span class="dashboard-rms-card-label">Male</span>
      </div>
    </div>
    <div class="dashboard-rms-card">
      <div class="dashboard-rms-card-icon-wrap dashboard-rms-icon-purple">
        <i class="fas fa-venus"></i>
      </div>
      <div class="dashboard-rms-card-body">
        <span class="dashboard-rms-card-value">{{ stats.total_female|default:0 }}</span>
        <span class="dashboard-rms-card-label">Female</span>
      </div>
    </div>
    <div class="dashboard-rms-card">
      <div class="dashboard-rms-card-icon-wrap dashboard-rms-icon-orange">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="dashboard-rms-card-body">
        <span class="dashboard-rms-card-value">{{ stats.total_voters|default:0 }}</span>
        <span class="dashboard-rms-card-label">Voters</span>
      </div>
    </div>
  </div>

  <!-- Additional Statistics -->
  <section class="dashboard-rms-additional">
    <h2 class="dashboard-rms-additional-title">Additional Statistics</h2>
    <div class="dashboard-rms-additional-grid">
      <div class="dashboard-rms-additional-item">
        <span class="dashboard-rms-additional-label">Senior Citizens</span>
        <span class="dashboard-rms-additional-value">{{ stats.total_senior_citizen|default:0 }}</span>
      </div>
      <div class="dashboard-rms-additional-item">
        <span class="dashboard-rms-additional-label">PWD</span>
        <span class="dashboard-rms-additional-value">{{ stats.total_pwd|default:0 }}</span>
      </div>
      <div class="dashboard-rms-additional-item">
        <span class="dashboard-rms-additional-label">Sole Parents</span>
        <span class="dashboard-rms-additional-value">{{ stats.total_solo_parent|default:0 }}</span>
      </div>
      <div class="dashboard-rms-additional-item">
        <span class="dashboard-rms-additional-label">4Ps</span>
        <span class="dashboard-rms-additional-value">{{ stats.total_4ps_member|default:0 }}</span>
      </div>
    </div>
  </section>

  <!-- Charts row -->
  <div class="dashboard-rms-charts">
    <section class="dashboard-rms-chart-card">
      <h2 class="dashboard-rms-chart-title">Alive & Deceased</h2>
      <p class="dashboard-rms-chart-subtitle">By registration month</p>
      <div class="dashboard-rms-chart-legend">
        <span class="dashboard-rms-legend-item dashboard-rms-legend-alive"><i class="fas fa-circle"></i> Alive: <strong>{{ stats.total_alive|default:0 }}</strong></span>
        <span class="dashboard-rms-legend-item dashboard-rms-legend-dead"><i class="fas fa-circle"></i> Deceased: <strong>{{ stats.total_dead|default:0 }}</strong></span>
      </div>
      <div class="dashboard-rms-chart-wrap">
        <canvas id="aliveDeadChart" height="220"></canvas>
      </div>
    </section>
    <section class="dashboard-rms-chart-card">
      <h2 class="dashboard-rms-chart-title">Residents by Birth Year</h2>
      <p class="dashboard-rms-chart-subtitle">Distribution by birth year</p>
      <div id="birthYearPeak" class="dashboard-rms-chart-peak" style="display: none;"></div>
      <div class="dashboard-rms-chart-wrap">
        <canvas id="birthYearChart" height="220"></canvas>
      </div>
    </section>
    <section class="dashboard-rms-chart-card dashboard-rms-chart-card-full">
      <h2 class="dashboard-rms-chart-title">Total Barangays &amp; Municipalities</h2>
      <p class="dashboard-rms-chart-subtitle">Active barangays and municipalities in the system</p>
      <div class="dashboard-rms-chart-wrap dashboard-rms-chart-wrap-bar-muni">
        <canvas id="barMuniChart" height="220"></canvas>
      </div>
    </section>
  </div>
</div>

<!-- Custom chart tooltip (used by both charts) -->
<div id="chartTooltip" class="chart-tooltip-custom" style="display: none;"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
  var chartData = {{ chart_data_json|safe }};
  if (!chartData || !chartData.labels || !chartData.labels.length) {
    document.getElementById('aliveDeadChart').parentElement.innerHTML = '<p class="dashboard-rms-chart-empty">No resident data by month yet.</p>';
    return;
  }
  var ctx = document.getElementById('aliveDeadChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: chartData.labels,
      datasets: [
        {
          label: 'Alive',
          data: chartData.alive,
          backgroundColor: 'rgba(40, 167, 69, 0.8)',
          borderColor: 'rgb(40, 167, 69)',
          borderWidth: 1
        },
        {
          label: 'Deceased',
          data: chartData.dead,
          backgroundColor: 'rgba(220, 53, 69, 0.8)',
          borderColor: 'rgb(220, 53, 69)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: false,
          external: function(context) {
            var el = document.getElementById('chartTooltip');
            if (!context.tooltip || context.tooltip.opacity === 0) {
              el.style.display = 'none';
              return;
            }
            var tooltip = context.tooltip;
            var idx = tooltip.dataPoints && tooltip.dataPoints[0] ? tooltip.dataPoints[0].dataIndex : 0;
            var label = (chartData.labels && chartData.labels[idx]) ? chartData.labels[idx] : '';
            var aliveVal = chartData.alive[idx] != null ? chartData.alive[idx] : 0;
            var deadVal = chartData.dead[idx] != null ? chartData.dead[idx] : 0;
            el.innerHTML =
              '<div class="chart-tooltip-title">' + (label || '') + '</div>' +
              '<div class="chart-tooltip-line chart-tooltip-alive">Alive : ' + aliveVal + '</div>' +
              '<div class="chart-tooltip-line chart-tooltip-dead">Deceased : ' + deadVal + '</div>';
            el.style.display = 'block';
            el.style.opacity = '1';
            var canvas = context.chart.canvas.getBoundingClientRect();
            var left = canvas.left + tooltip.caretX + 10;
            var top = canvas.top + tooltip.caretY - el.offsetHeight / 2;
            el.style.left = left + 'px';
            el.style.top = top + 'px';
          }
        }
      },
      scales: {
        x: {
          title: { display: false },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Count' },
          ticks: { stepSize: 1 }
        }
      }
    }
  });
})();

(function() {
  var birthYearData = {{ birth_year_data_json|safe }};
  if (!birthYearData || !birthYearData.labels || !birthYearData.labels.length) {
    document.getElementById('birthYearChart').parentElement.innerHTML = '<p class="dashboard-rms-chart-empty">No birth year data available yet.</p>';
    return;
  }
  var ctx = document.getElementById('birthYearChart').getContext('2d');
  var maxCount = Math.max.apply(null, birthYearData.counts);
  var maxYearIdx = birthYearData.counts.indexOf(maxCount);
  var maxYear = birthYearData.labels[maxYearIdx];
  var peakEl = document.getElementById('birthYearPeak');
  if (peakEl) {
    peakEl.innerHTML = '<i class="fas fa-chart-line"></i> Peak Year: ' + maxYear + ' with ' + maxCount + ' residents';
    peakEl.style.display = 'flex';
  }
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: birthYearData.labels,
      datasets: [{
        label: 'Residents',
        data: birthYearData.counts,
        backgroundColor: 'rgba(66, 153, 225, 0.8)',
        borderColor: 'rgb(66, 153, 225)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: false,
          external: function(context) {
            var el = document.getElementById('chartTooltip');
            if (!context.tooltip || context.tooltip.opacity === 0) {
              el.style.display = 'none';
              return;
            }
            var tooltip = context.tooltip;
            var idx = tooltip.dataPoints && tooltip.dataPoints[0] ? tooltip.dataPoints[0].dataIndex : 0;
            var year = birthYearData.labels[idx] != null ? birthYearData.labels[idx] : '';
            var count = birthYearData.counts[idx] != null ? birthYearData.counts[idx] : 0;
            el.innerHTML =
              '<div class="chart-tooltip-title">' + year + '</div>' +
              '<div class="chart-tooltip-line chart-tooltip-residents">residents : ' + count + '</div>';
            el.style.display = 'block';
            el.style.opacity = '1';
            var canvas = context.chart.canvas.getBoundingClientRect();
            var left = canvas.left + tooltip.caretX + 10;
            var top = canvas.top + tooltip.caretY - el.offsetHeight / 2;
            el.style.left = left + 'px';
            el.style.top = top + 'px';
          }
        }
      },
      scales: {
        x: {
          title: { display: false },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Count' },
          ticks: { stepSize: 1 }
        }
      }
    }
  });
})();

(function() {
  var barMuniData = {{ bar_muni_chart_json|safe }};
  var canvas = document.getElementById('barMuniChart');
  if (!canvas || !barMuniData || !barMuniData.labels || !barMuniData.labels.length) {
    if (canvas && canvas.parentElement) {
      canvas.parentElement.innerHTML = '<p class="dashboard-rms-chart-empty">No barangay or municipality data yet.</p>';
    }
    return;
  }
  var ctx = canvas.getContext('2d');
  var colors = ['rgba(66, 153, 225, 0.8)', 'rgba(124, 58, 237, 0.8)'];
  var borders = ['rgb(66, 153, 225)', 'rgb(124, 58, 237)'];
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: barMuniData.labels,
      datasets: [{
        label: 'Count',
        data: barMuniData.counts,
        backgroundColor: colors,
        borderColor: borders,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: false,
          external: function(context) {
            var el = document.getElementById('chartTooltip');
            if (!context.tooltip || context.tooltip.opacity === 0) {
              el.style.display = 'none';
              return;
            }
            var tooltip = context.tooltip;
            var idx = tooltip.dataPoints && tooltip.dataPoints[0] ? tooltip.dataPoints[0].dataIndex : 0;
            var label = barMuniData.labels[idx] != null ? barMuniData.labels[idx] : '';
            var count = barMuniData.counts[idx] != null ? barMuniData.counts[idx] : 0;
            el.innerHTML =
              '<div class="chart-tooltip-title">' + label + '</div>' +
              '<div class="chart-tooltip-line chart-tooltip-residents">total : ' + count + '</div>';
            el.style.display = 'block';
            el.style.opacity = '1';
            var rect = context.chart.canvas.getBoundingClientRect();
            var left = rect.left + tooltip.caretX + 10;
            var top = rect.top + tooltip.caretY - (el.offsetHeight / 2);
            el.style.left = left + 'px';
            el.style.top = top + 'px';
          }
        }
      },
      scales: {
        x: {
          title: { display: false },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Count' },
          ticks: { stepSize: 1 }
        }
      }
    }
  });
})();
</script>
{% endblock %}
